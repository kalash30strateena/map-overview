<!DOCTYPE html>
<html>
<head>
  <title>Mapa de Argentina - CSV Dots by Year (Floods & Labour Integrated)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body, #main-layout { height: 100vh; width: 100vw; overflow: hidden; }
    #folder-controls { width: 100vw; padding: 12px 10px 0 10px; background: #fff; z-index: 1001; position: relative; box-sizing: border-box; border-bottom: 1px solid #eee; }
    #folder-controls button,
    #file-controls button {
      margin-right: 10px;
      margin-bottom: 5px;
      padding: 6px 15px;
      font-size: 16px;
      background: #fff;
      border: none;
      border-bottom: 2px solid #bbb;
      border-radius: 0;
      color: #800000;
      cursor: pointer;
      transition: none;
      outline: none;
    }
    #folder-controls button.active,
    #file-controls button.active {
      background: #fff;
      color: #fc0004;
      border-bottom: 2px solid #fc0004;
    }
    #folder-controls button:hover,
    #file-controls button:hover {
      background: #fff;
      color: #800000;
      border-bottom: 2px solid #bbb;
    }
    #main-layout { display: flex; flex-direction: row; height: calc(100vh - 55px); width: 100vw; position: relative; }
    #year-panel { width: 150px; min-width: 110px; background: #fff; border-right: 1px solid #eee; box-sizing: border-box; z-index: 1002; display: flex; flex-direction: column; align-items: stretch; padding: 25px 10px 10px 10px; position: relative; height: 100%; }
    #year-panel h4 { margin: 0 0 15px 0; color: #800000; font-size: 17px; font-weight: 600; text-align: left; }
    #file-controls { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    #flood-filters { margin-top: 18px; margin-bottom: 10px; display: none; }
    #flood-filters label { font-weight: bold; color: #222; margin-bottom: 5px; display: block; }
    #flood-filters input[type="checkbox"] { margin-right: 4px; }
    #map { flex: 1 1 0%; position: relative; height: 100%; width: 100%; z-index: 1; }
    #info-panel { display: none; position: relative; width: 370px; min-width: 180px; height: 100%; overflow-y: auto; background: rgba(255,255,255,0.98); border-left: 1px solid #eee; z-index: 9999; padding: 30px 18px 18px 18px; font-family: Arial, sans-serif; transition: box-shadow 0.2s; box-shadow: 0 0 24px rgba(0,0,0,0.10); }
    #info-panel h3 { margin-top: 0; font-size: 20px; margin-bottom: 12px; color: #3388ff; }
    #info-panel table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    #info-panel th, #info-panel td { text-align: left; padding: 4px 7px; border-bottom: 1px solid #eee; font-size: 15px; }
    #info-panel th { background: #fff; color: #3388ff; font-weight: 600; width: 40%; }
    #info-panel .close-btn { position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 20px; color: #888; cursor: pointer; transition: color 0.2s; }
    #info-panel .close-btn:hover { color: #3388ff; }
    @media (max-width: 900px) {
      #main-layout { flex-direction: column; height: auto; }
      #year-panel { flex-direction: row; width: 100vw; height: auto; min-width: unset; border-right: none; border-bottom: 1px solid #eee; padding: 10px 5px 10px 5px; align-items: center; }
      #year-panel h4 { margin-bottom: 0; margin-right: 10px; }
      #file-controls { flex-direction: row; gap: 8px; }
      #map { width: 100vw; height: 50vh; min-height: 250px; }
      #info-panel { width: 100vw; left: 0; right: 0; border-left: none; border-top: 1px solid #eee; box-shadow: 0 -4px 24px rgba(0,0,0,0.10); padding: 18px 10px 10px 10px; height: 50vh; top: auto; bottom: 0; }
    }
  </style>
</head>
<body>
  <div id="folder-controls"></div>
  <div id="main-layout">
    <div id="year-panel">
      <h4>Año</h4>
      <div id="file-controls"></div>
      <div id="flood-filters">
        <label>Incidence Level:</label>
        <input type="checkbox" name="incidence" value="1" onchange="drawFloodMap()"> Live<br>
        <input type="checkbox" name="incidence" value="2" onchange="drawFloodMap()"> Moderate<br>
        <input type="checkbox" name="incidence" value="3" onchange="drawFloodMap()"> Criticism<br>
      </div>
    </div>
    <div id="map"></div>
    <div id="info-panel">
      <button class="close-btn" onclick="hideInfoPanel()" title="Cerrar">&times;</button>
      <h3>Detalles del punto</h3>
      <div id="info-content"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const folderStructure = {
      "Informal settlements": [
        "app/static/Informal settlements/2022.csv",
        "app/static/Informal settlements/2023.csv"
      ],
      "Vital stats": [
        "app/static/Vital stats/2005.csv",
        "app/static/Vital stats/2010.csv",
        "app/static/Vital stats/2015.csv",
        "app/static/Vital stats/2018.csv",
        "app/static/Vital stats/2021.csv"
      ],
      "Floods": [
        "app/static/Floods/2001.csv",
        "app/static/Floods/2010.csv",
        "app/static/Floods/2024.csv"
      ]
    };

    const defaultStyle = {
      radius: 6,
      color: '#3388ff',
      fillColor: '#3388ff',
      fillOpacity: 0.8,
      weight: 1
    };
    const highlightStyle = {
      radius: 7,
      color: '#fc0004',
      fillColor: '#fc0004',
      fillOpacity: 1,
      weight: 2
    };
    function getFloodColor(level) {
      switch (String(level)) {
        case "1": return "#add8e6";
        case "2": return "#3399ff";
        case "3": return "#003f7f";
        default: return "#888";
      }
    }

    let lastClickedMarker = null;
    let lastHoveredMarker = null;
    let currentFolder = null;
    let currentFile = null;
    let currentFloodIncidenceKey = null;
    let currentFloodData = [];

    var map = L.map('map').setView([-38.4161, -63.6167], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap',
      maxZoom: 18,
    }).addTo(map);
    var dotsLayer = L.layerGroup().addTo(map);

    function renderFolderButtons() {
      const folderDiv = document.getElementById('folder-controls');
      folderDiv.innerHTML = '';
      Object.keys(folderStructure).forEach(folder => {
        const btn = document.createElement('button');
        btn.textContent = folder;
        btn.className = (folder === currentFolder) ? 'active' : '';
        btn.onclick = () => {
          currentFolder = folder;
          currentFile = null;
          renderFolderButtons();
          renderFileButtons(folder);
        };
        folderDiv.appendChild(btn);
      });
    }

    function renderFileButtons(folder) {
      const fileDiv = document.getElementById('file-controls');
      fileDiv.innerHTML = '';
      folderStructure[folder].forEach(filePath => {
        const fileName = filePath.split('/').pop().replace('.csv','');
        const btn = document.createElement('button');
        btn.textContent = fileName;
        btn.className = (filePath === currentFile) ? 'active' : '';
        btn.onclick = () => {
          currentFile = filePath;
          renderFileButtons(folder);
          if (folder === "Floods") {
            loadFloodCSV(filePath);
          } else if (folder === "Labour and Social") {
            loadLabourCSV(filePath);
          } else {
            loadCSV(filePath);
          }
        };
        fileDiv.appendChild(btn);
      });
      document.getElementById('flood-filters').style.display = (folder === "Floods") ? "block" : "none";
      if(!currentFile && folderStructure[folder].length > 0) {
        currentFile = folderStructure[folder][0];
        renderFileButtons(folder);
        if (folder === "Floods") {
          loadFloodCSV(currentFile);
        } else if (folder === "Labour and Social") {
          loadLabourCSV(currentFile);
        } else {
          loadCSV(currentFile);
        }
      }
    }

    function showInfoPanel(row) {
      const infoPanel = document.getElementById('info-panel');
      const infoContent = document.getElementById('info-content');
      let html = '<table>';
      for (const key in row) {
        if (row[key] !== "" && row[key] !== null && row[key] !== undefined) {
          html += `<tr><th>${key}</th><td>${row[key]}</td></tr>`;
        }
      }
      html += '</table>';
      infoContent.innerHTML = html;
      infoPanel.style.display = 'block';
    }

    function hideInfoPanel() {
      document.getElementById('info-panel').style.display = 'none';
      if (lastClickedMarker) {
        lastClickedMarker.setStyle(lastClickedMarker._floodLevelStyle || defaultStyle);
        lastClickedMarker = null;
      }
    }

    // --- General CSV loader (Informal settlements, Vital stats) ---
    function loadCSV(filename) {
      dotsLayer.clearLayers();
      document.getElementById('info-panel').style.display = 'none';
      lastClickedMarker = null;
      lastHoveredMarker = null;
      fetch(filename)
        .then(response => {
          if (!response.ok) throw new Error("File not found: " + filename);
          return response.text();
        })
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              var data = results.data;
              var bounds = [];
              data.forEach(function(row) {
                var lat = parseFloat(row['Latitud del centroide'] || row['latitude'] || row['lat']);
                var lng = parseFloat(row['Longitud del centroide'] || row['longitude'] || row['lon']);
                if (!isNaN(lat) && !isNaN(lng)) {
                  var circle = L.circleMarker([lat, lng], defaultStyle)
                    .addTo(dotsLayer)
                    .on('click', function(e) {
                      if (lastClickedMarker && lastClickedMarker !== this) {
                        lastClickedMarker.setStyle(defaultStyle);
                      }
                      this.setStyle(highlightStyle);
                      lastClickedMarker = this;
                      showInfoPanel(row);
                    });
                  bounds.push([lat, lng]);
                }
              });
              if (bounds.length > 0) {
                map.fitBounds(bounds);
              }
            }
          });
        })
        .catch(error => {
          dotsLayer.clearLayers();
          alert("Error loading file: " + filename);
        });
    }

    // --- Floods CSV loader (uses only Latitud del centroide/Longitud del centroide) ---
    function loadFloodCSV(file) {
      dotsLayer.clearLayers();
      document.getElementById('info-panel').style.display = 'none';
      lastClickedMarker = null;
      lastHoveredMarker = null;
      document.querySelectorAll('#flood-filters input[type="checkbox"]').forEach(cb => cb.checked = false);
      fetch(file)
        .then(response => {
          if (!response.ok) throw new Error("File not found: " + file);
          return response.text();
        })
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              currentFloodData = results.data;
              currentFloodIncidenceKey = results.meta.fields.find(h => h.toLowerCase().includes("nivel de incidencia"));
              document.getElementById('flood-filters').style.display = currentFloodIncidenceKey ? "block" : "none";
              drawFloodMap();
            }
          });
        })
        .catch(error => {
          dotsLayer.clearLayers();
          alert("Error loading file: " + file);
        });
    }

    function drawFloodMap() {
      dotsLayer.clearLayers();
      document.getElementById('info-panel').style.display = 'none';
      lastClickedMarker = null;
      lastHoveredMarker = null;
      const checked = Array.from(document.querySelectorAll('#flood-filters input[name="incidence"]:checked')).map(i => i.value);
      var bounds = [];
      currentFloodData.forEach(row => {
        const lat = parseFloat(row["Latitud del centroide"]);
        const lon = parseFloat(row["Longitud del centroide"]);
        if (isNaN(lat) || isNaN(lon)) return;
        const level = currentFloodIncidenceKey ? row[currentFloodIncidenceKey] : null;
        if (currentFloodIncidenceKey && checked.length && !checked.includes(level)) return;
        const style = {
          radius: 6,
          color: getFloodColor(level),
          fillColor: getFloodColor(level),
          fillOpacity: 0.85,
          weight: 1
        };
        const highlight = {
          radius: 7,
          color: '#fc0004',
          fillColor: '#fc0004',
          fillOpacity: 1,
          weight: 2
        };
        var circle = L.circleMarker([lat, lon], style)
          .addTo(dotsLayer)
          .on('click', function(e) {
            if (lastClickedMarker && lastClickedMarker !== this) {
              lastClickedMarker.setStyle(lastClickedMarker._floodLevelStyle || style);
            }
            this.setStyle(highlight);
            this._floodLevelStyle = style; // save for unhighlight
            lastClickedMarker = this;
            showInfoPanel(row);
          });
        circle._floodLevelStyle = style;
        bounds.push([lat, lon]);
      });
      if (bounds.length > 0) map.fitBounds(bounds);
    }

    // --- Labour and Social CSV loader (uses only Latitud del centroide/Longitud del centroide) ---
    function loadLabourCSV(file) {
      dotsLayer.clearLayers();
      document.getElementById('info-panel').style.display = 'none';
      lastClickedMarker = null;
      lastHoveredMarker = null;
      fetch(file)
        .then(response => {
          if (!response.ok) throw new Error("File not found: " + file);
          return response.text();
        })
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              var data = results.data;
              var bounds = [];
              data.forEach(function(row) {
                var lat = parseFloat(row['Latitud del centroide']);
                var lng = parseFloat(row['Longitud del centroide']);
                if (!isNaN(lat) && !isNaN(lng)) {
                  var circle = L.circleMarker([lat, lng], defaultStyle)
                    .addTo(dotsLayer)
                    .on('click', function(e) {
                      if (lastClickedMarker && lastClickedMarker !== this) {
                        lastClickedMarker.setStyle(defaultStyle);
                      }
                      this.setStyle(highlightStyle);
                      lastClickedMarker = this;
                      showInfoPanel(row);
                    });
                  bounds.push([lat, lng]);
                }
              });
              if (bounds.length > 0) {
                map.fitBounds(bounds);
              }
            }
          });
        })
        .catch(error => {
          dotsLayer.clearLayers();
          alert("Error loading file: " + file);
        });
    }

    window.onload = function() {
      currentFolder = Object.keys(folderStructure)[0];
      currentFile = null;
      renderFolderButtons();
      renderFileButtons(currentFolder);
    };
  </script>
</body>
</html>
